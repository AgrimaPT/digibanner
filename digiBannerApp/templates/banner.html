{% load custom_filters %}

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Banner Slider</title>
  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <!-- jQuery (full version) -->
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <style>
    /* Basic styling for carousel items */
    .carousel-item video, .carousel-item img {
      width: 100%;
      height: auto;
    }
  </style>
</head>
<body>
  <div id="bannerCarousel" class="carousel slide" data-ride="carousel">
    <!-- Carousel Indicators -->
    <ol id="carousel-indicators" class="carousel-indicators">
      {% for banner in banners %}
        <li data-target="#bannerCarousel" data-slide-to="{{ forloop.counter0 }}" class="{% if forloop.first %}active{% endif %}"></li>
      {% endfor %}
    </ol>
    <!-- Carousel Items -->
    <div id="carousel-inner" class="carousel-inner">
      {% for banner in banners %}
        <div class="carousel-item {% if forloop.first %}active{% endif %}">
          {% if banner.media %}
            {% if banner.media.url|lower|endswith:".mp4" %}
              <video width="100%" controls autoplay muted>
                <source src="{{ banner.media.url }}" type="video/mp4">
                Your browser does not support the video tag.
              </video>
            {% else %}
              <img src="{{ banner.media.url }}" alt="{{ banner.title }}" class="d-block w-100">
            {% endif %}
          {% else %}
            <p>{{ banner.title }}</p>
          {% endif %}
        </div>
      {% endfor %}
    </div>
    <!-- Carousel Controls -->
    <a class="carousel-control-prev" href="#bannerCarousel" role="button" data-slide="prev">
      <span class="carousel-control-prev-icon" aria-hidden="true"></span>
      <span class="sr-only">Previous</span>
    </a>
    <a class="carousel-control-next" href="#bannerCarousel" role="button" data-slide="next">
      <span class="carousel-control-next-icon" aria-hidden="true"></span>
      <span class="sr-only">Next</span>
    </a>
  </div>

  <!-- Bootstrap JS (with bundle including Popper) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>

  <!-- AJAX Script to Update Carousel and Video Handling -->
  <script>
    // Track current banner IDs
    var currentBannerIds = [];

    // Function to rebuild carousel HTML based on banner data
    function updateCarousel(banners) {
      var newBannerIds = banners.map(function(banner) { return banner.id; });
      if (JSON.stringify(newBannerIds) === JSON.stringify(currentBannerIds)) {
        console.log('No change in banners. Skipping update.');
        return;
      }
      currentBannerIds = newBannerIds;
      
      var indicators = '';
      var items = '';

      $.each(banners, function(index, banner) {
        var activeClass = (index === 0) ? 'active' : '';
        indicators += '<li data-target="#bannerCarousel" data-slide-to="' + index + '" class="' + activeClass + '"></li>';

        var mediaUrl = banner.media_url;
        console.log("Banner ID " + banner.id + " mediaUrl:", mediaUrl);
        var mediaTag = '';

        if (mediaUrl) {
          if (mediaUrl.toLowerCase().endsWith('.mp4')) {
            // Add muted for autoplay to work in most browsers
            mediaTag = '<video width="100%" controls autoplay muted>' +
                         '<source src="' + mediaUrl + '" type="video/mp4">' +
                         'Your browser does not support the video tag.' +
                       '</video>';
          } else {
            mediaTag = '<img src="' + mediaUrl + '" class="d-block w-100" alt="' + banner.title + '">';
          }
        } else {
          mediaTag = '<p>' + banner.title + '</p>';
        }

        if (banner.url && banner.url !== "undefined") {
          mediaTag = '<a href="' + banner.url + '">' + mediaTag + '</a>';
        }

        items += '<div class="carousel-item ' + activeClass + '">' + mediaTag + '</div>';
      });

      $('#carousel-indicators').html(indicators);
      $('#carousel-inner').html(items);

      $('#bannerCarousel').carousel('dispose');
      $('#bannerCarousel').carousel({
        interval: 5000,
        pause: false
      });
      $('#bannerCarousel').carousel('cycle');
    }

    // Function to fetch banner data from the server
    function fetchBannerData() {
      $.ajax({
        url: '/banner_data/',
        type: 'GET',
        dataType: 'json',
        success: function(data) {
          if (data && data.banners) {
            updateCarousel(data.banners);
          }
        },
        error: function(xhr, status, error) {
          console.error("Error fetching banners: " + error);
        }
      });
    }

    // Poll for updates every 3 seconds
    setInterval(fetchBannerData, 3000);

    $(document).ready(function() {
      fetchBannerData();

      // When slide transition is complete, check for video in the active slide.
      $('#bannerCarousel').on('slid.bs.carousel', function () {
        var activeSlide = $(this).find('.carousel-item.active');
        var video = activeSlide.find('video');
        if (video.length > 0) {
          console.log("Video detected in active slide. Pausing carousel.");
          // Pause carousel
          $('#bannerCarousel').carousel('pause');
          // Ensure the video plays (if not already playing)
          var vidElement = video[0];
          if (vidElement.paused) {
            vidElement.play();
          }
          // When video ends, resume carousel and go to next slide.
          video.off('ended').on('ended', function() {
            console.log("Video ended. Moving to next slide.");
            $('#bannerCarousel').carousel('cycle');
            $('#bannerCarousel').carousel('next');
          });
        } else {
          console.log("No video in active slide. Carousel running normally.");
        }
      });
    });
  </script>
</body>
</html>